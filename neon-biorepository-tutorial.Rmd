---
title: "NEON Biorepository Data Tutorial"
author: "Kelsey Yule"
date: "2024-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Learning Objectives

In this tutorial, we will learn how to develop a sample list to optimally answer a research question based on NEON data product and NEON Biorepository sample availability.

1. Outline a broad research question.

2. Download related data from the main NEON data portal using the `neonUtilities` R package.

3. Compare NEON data availability across multiple data products in order to narrow research scope.

4. Identify NEON Biorepository samples that match the research scope of interest  using NEON Biorepository data: https://biorepo.neonscience.org

## Research question

We are interested in testing for relationships between small mammal diet and the carbon and nitrogen stable isotope ratios in co-occurring plant communities. NEON provides extensive information about stable isotopes from samples collected from the canopy and in litter traps. While NEON does not measure small mammal diets as part of its focal protocols, NEON archives both hair and fecal samples that researchers can use to gain these insights.

**What samples from the NEON Biorepository can be requested in order to conduct this study?** 

To answer this this question, we need to understand where there is spatial and temporal overlap in measurements of canopy foliar chemistry, litter chemistry, and mammal sampling.

We will attempt to develop a list of samples following these criteria:

- Site and year combinations for which carbon nitrogen ratio measurements are available for _both_ canopy foliage and litter

- Common species for which we can achieve a minimum viable sample size for our study

- Both a hair and a fecal sample were collected from the same individual

## Background information on the NEON Biorepository

The NEON Biorepository is located at Arizona State University and serves as the primary repository for NEON samples and specimens collected across all 81 NEON field sites. 

The NEON Biorepository data portal allows users to search and download records associated with NEON samples and specimens, request samples and specimens for research, and publish sample-associated data. The NEON Biorepository data portal is built on open-source **Symbiota** software. **Symbiota** is the most frequently used software in North America for managing natural history collections records. Learn more about **Symbiota** data portals at https://symbiota.org/

Symbiota portals publish sample, specimen, and observation data following **Darwin Core Standard** developed by Biodiversity Information Standards (TDWG). This data standard is a stable, straightforward, and flexible framework for compiling biodiversity data from varied sources. Learn more at https://dwc.tdwg.org/

## Getting Started

First, we want to clear out our workspace and load the required packages. If you do not have the required packages installed previously do so with the `install.packages()` function.

```{r set up, message=FALSE, warning=FALSE}
# clean out workspace

# rm(list = ls()) # OPTIONAL - clear out your environment

# load packages
library(tidyverse)
library(neonUtilities)
library(curl)

```

## Obtain relevant NEON Terrestrial Observation System data

In order to answer our question, we need to know which NEON sites and years correspond to available carbon and nitrogen stable isotope data for canopy foliage and litter samples. We will use the `neonUtilities` package to download all of the data from these two data products from the main NEON data portal. This requires that we know the NEON data product IDs for each relevant data product. 

**NEON Plant Foliar Traits:** "DP1.10026.001" described at  https://data.neonscience.org/data-products/DP1.10026.001

**NEON Litterfall and fine woody debris production and chemistry:** "DP1.10033.001" described at  https://data.neonscience.org/data-products/DP1.10033.001

The below piece of code allows you to download the data as of 2024-08-02 from the GitHub repository associated with this tutorial. We will obtain the data in this way because newly downloading data from the NEON API can be time intensive.

```{r loadNeondata, message=FALSE, warning=FALSE}

# Data required for the study of canopy foliar chemistry

NEON.cfc<-readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/NEON_cfc.Rdata")))

# Data required for the study of litter chemistry

NEON.ltr<-readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/NEON_ltr.Rdata")))
```

The below code shows how you could download an up-to-date version of this data via the NEON API. Note that we have chosen to include Provisional data for this exploratory analysis. To learn more about Release vs. Provisional NEON data and ensure that you choose the appropriate data for your purposes, visit the following link: https://www.neonscience.org/resources/learning-hub/tutorials/release-provisional-tutorial.

```{r downloadDataNew},message=FALSE}

### source .r file with my NEON_TOKEN
# source("my_neon_token.R") # OPTIONAL - load NEON token
# See: https://www.neonscience.org/neon-api-tokens-tutorial

### Use the loadByProduct function. Use ?loadByProduct to view the many other options that can be specified

 #NEON.cfc <- loadByProduct(dpID="DP1.10026.001",
                    #package="expanded",
                    #include.provisional=TRUE,
                    #check.size=FALSE,
                    #token=Neon_Token)
 
 #NEON.ltr <- loadByProduct(dpID="DP1.10033.001",
                    #include.provisional=TRUE,
                    #check.size=FALSE,
                    #token=Neon_Token)

```

Let's take a look at what is included in each NEON data product download. We will extract and focus on the table that has colated all of the records for individual traps.

```{r whatsInADownload},message=FALSE,evaluate=FALSE}

# What's in a download?
names(NEON.cfc)
names(NEON.ltr)

```

We can see that the data downloads for each product include several tables. The Quick Start Guides on any NEON data product description page are especially useful for understanding these tables, as are the "variables" and "readme" files included in data downloads. It is recommended that anyone who plans to use NEON data in their work carefully review the associated reading materials. 

For our purpose, we are interested in the files containing measurements of carbon and nitrogen.

```{r whatsInADownload},message=FALSE,evaluate=FALSE}

# What's in a download?
names(NEON.cfc)
names(NEON.ltr)

```


## Load and explore NEON Biorepository data

Here, we read in a csv file of occurrence records downloaded from the NEON Biorepository data portal. The results are located in the Github repository https://github.com/kyule/neon-biorepo-tutorial and represent a search for all small mammal hair and fecal samples collected in 2018-2023 and archived at the NEON Biorepository as of 2024-08-02.

Up to date results for the same search terms can be found at any time using the link: 
https://biorepo.neonscience.org/portal/collections/list.php?db=26%2C27&includeothercatnum=1&eventdate1=2018-01-01&eventdate2=2023-12-31&usethes=1&taxontype=1&availableforloan=1

```{r load data, message=FALSE, warning=FALSE}
biorepo<-read.csv(curl("https://github.com/kyule/neon-biorepo-tutorial/raw/main/biorepoOccurrences_FecalAndHairSamples_20240802.csv"))
```

Let's look at what information is included in a Darwin Core occurrence record.

```{r investigate},message=FALSE,evaluate=FALSE}
# What variables exist for the records?

names(biorepo)

```
We see that a large number of Darwin Core fields are present in the results that outline the who, what, where, when, and more of each sample. For fun, let's explore the data. Try grouping or summarizing by fields that interest you.

```{r explorefields},message=FALSE,evaluate=FALSE}
# How many samples are included in the results for each collection, species, and sex?

biorepo %>% 
  group_by(collectionCode,scientificName,sex) %>% 
  count()

```

Different collectionCodes correspond to different sample types. "MAMC-FE" corresponds to the Mammal Fecal Sample Collection described here: https://biorepo.neonscience.org/portal/collections/misc/collprofiles.php?collid=26). "MAMC-HA" corresponds to the Mammal Hair Sample Collection described here: https://biorepo.neonscience.org/portal/collections/misc/collprofiles.php?collid=27). 

We see several different taxa represented within the results. Most samples are associated with a species-level determination. A few are identified only to genus and others are given a "/" taxon. The latter represent uncertain identification between two species that are difficult to distinguish at a given field site. For example, individuals identified as _Peromyscus leucopus/maniculatus_ could not be confidently determined to be either _P. maniculatus_ or _P. leucopus_ in the field.

## Obtain relevant NEON Terrestrial Observation System data

In order to compare field and Biorepository measurements of body mass, we also need to obtain field data from the main NEON data portal. We will use the `neonUtilities` package to download all small mammal capture data from the main NEON data portal. This requires that we know the NEON data product ID for small mammals, which is DP1.10072.001: https://data.neonscience.org/data-products/DP1.10072.001

The below code chunk allows you to download the data as of 2024-07-30 from the GitHub repository associated with this tutorial.

```{r loadNeondata, message=FALSE, warning=FALSE}
NEON<-readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/mammalCaptures_20240730.Rdata")))
```

The below code shows how you could download an up-to-date version of this data. The code is commented out because we will not download new data today due to the time that would be required to do so. Note that we have chosen to include Provisional data for this exploratory analysis. To learn more about Release vs. Provisional NEON data and ensure that you choose the appropriate data for your purposes, visit the following link: https://www.neonscience.org/resources/learning-hub/tutorials/release-provisional-tutorial.

```{r downloadDataNew},message=FALSE}

### source .r file with my NEON_TOKEN
# source("my_neon_token.R") # OPTIONAL - load NEON token
# See: https://www.neonscience.org/neon-api-tokens-tutorial

### Use the loadByProduct function. Use ?loadByProduct to view the many other options that can be specified

# NEON <- loadByProduct(dpID="DP1.10072.001",
#                   package="expanded",
#                   include.provisional=TRUE,
#                   token=NEON_TOKEN)

```

Let's take a look at what is included in a NEON data product download. We will extract and focus on the table that has colated all of the records for individual traps.

```{r whatsInADownload},message=FALSE,evaluate=FALSE}

# What's in a download?
names(NEON)

# Extract the "mam_pertrapnight" table
trap_data<-NEON$mam_pertrapnight
names(trap_data)

```

We are interested in the mammal trap-level data in order to match trapping events with records of Biorepository samples.


```{r getTrapNightData},message=FALSE}

# What's in a download?
names(NEON)

# Extract the "mam_pertrapnight" table
trap_data<-NEON$mam_pertrapnight
names(trap_data)

```

######## lasjdflaksjfjsldjf;aksdj


Subset the NEON Biorepository samples to DNA and fecal samples only based on collection code and potentially from _P. leucopus_.

```{r filter to },message=FALSE}

# Extract the "mam_pertrapnight" table
p_leucopus_dna_fecal<-biorepo %>%
                        filter(collectionCode %in% c("MAMC-DNA","MAMC-FE")) #%>%
                        #filter(specificEpithet,contains("leucopus"))
```
