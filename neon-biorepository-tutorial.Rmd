---
title: "NEON Biorepository Data Tutorial"
author: "Kelsey Yule"
date: "2024-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Learning Objectives

In this tutorial, we will learn how to develop a sample list to optimally answer a research question based on NEON data product and NEON Biorepository sample availability.

1. Outline a broad research question.

2. Download related data from the main NEON data portal using the `neonUtilities` R package.

3. Compare NEON data availability across multiple data products in order to narrow research scope.

4. Identify NEON Biorepository samples that match the research scope of interest  using NEON Biorepository data: https://biorepo.neonscience.org

## Research question

We are interested in testing for relationships between small mammal diet and the carbon and nitrogen stable isotope ratios in co-occurring plant communities. NEON provides extensive information about stable isotopes from samples collected from the canopy and in litter traps. While NEON does not measure small mammal diets as part of its focal protocols, NEON archives both hair and fecal samples that researchers can use to gain these insights.

**What samples from the NEON Biorepository can be requested in order to conduct this study?** 

To answer this this question, we need to understand where there is spatial and temporal overlap in measurements of canopy foliar chemistry, litter chemistry, and mammal sampling.

We will attempt to develop a list of samples following these criteria:

- Site and year combinations for which carbon nitrogen ratio measurements are available for _both_ canopy foliage and litter

- Common species for which we can achieve a minimum viable sample size for our study

- Both a hair and a fecal sample were collected from the same individual

## Background information on the NEON Biorepository

The NEON Biorepository is located at Arizona State University and serves as the primary repository for NEON samples and specimens collected across all 81 NEON field sites. 

The NEON Biorepository data portal allows users to search and download records associated with NEON samples and specimens, request samples and specimens for research, and publish sample-associated data. The NEON Biorepository data portal is built on open-source **Symbiota** software. **Symbiota** is the most frequently used software in North America for managing natural history collections records. Learn more about **Symbiota** data portals at https://symbiota.org/

Symbiota portals publish sample, specimen, and observation data following **Darwin Core Standard** developed by Biodiversity Information Standards (TDWG). This data standard is a stable, straightforward, and flexible framework for compiling biodiversity data from varied sources. Learn more at https://dwc.tdwg.org/

## Getting Started

First, we want to clear out our workspace and load the required packages. If you do not have the required packages installed previously do so with the `install.packages()` function.

```{r set up, message=FALSE, warning=FALSE}
# clean out workspace

# rm(list = ls()) # OPTIONAL - clear out your environment

# load packages

library(tidyverse)
library(neonUtilities)
library(curl)

```

## Obtain relevant NEON Terrestrial Observation System data

In order to answer our question, we need to know which NEON sites and years correspond to available carbon and nitrogen stable isotope data for canopy foliage and litter samples. We will use the `neonUtilities` package to download all of the data from these two data products from the main NEON data portal. This requires that we know the NEON data product IDs for each relevant data product. 

**NEON Plant Foliar Traits:** "DP1.10026.001" described at  https://data.neonscience.org/data-products/DP1.10026.001

**NEON Litterfall and fine woody debris production and chemistry:** "DP1.10033.001" described at  https://data.neonscience.org/data-products/DP1.10033.001

The below piece of code allows you to download the data as of 2024-08-02 from the GitHub repository associated with this tutorial. We will obtain the data in this way because newly downloading data from the NEON API can be time intensive.

```{r loadNeondata, message=FALSE, warning=FALSE}

# Data required for the study of canopy foliar chemistry

NEON.cfc <- readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/NEON_cfc.Rdata")))

# Data required for the study of litter chemistry

NEON.ltr <- readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/NEON_ltr.Rdata")))
```

The below code shows how you could download an up-to-date version of this data via the NEON API. Note that we have chosen to include Provisional data for this exploratory analysis. To learn more about Release vs. Provisional NEON data and ensure that you choose the appropriate data for your purposes, visit the following link: https://www.neonscience.org/resources/learning-hub/tutorials/release-provisional-tutorial.

```{r downloadDataNew},message=FALSE}

### source .r file with my NEON_TOKEN
# source("my_neon_token.R") # OPTIONAL - load NEON token
# See: https://www.neonscience.org/neon-api-tokens-tutorial

### Use the loadByProduct function. Use ?loadByProduct to view the many other options that can be specified

 #NEON.cfc <- loadByProduct(dpID="DP1.10026.001",
                    #package="expanded",
                    #include.provisional=TRUE,
                    #check.size=FALSE,
                    #token=Neon_Token)
 
 #NEON.ltr <- loadByProduct(dpID="DP1.10033.001",
                    #include.provisional=TRUE,
                    #check.size=FALSE,
                    #token=Neon_Token)

```

Let's take a look at what is included in each NEON data product download. We will extract and focus on the table that has colated all of the records for individual traps.

```{r whatsInADownload},message=FALSE,evaluate=FALSE}

# What's in a download?

names(NEON.cfc)
names(NEON.ltr)

```

We can see that the data downloads for each product include several tables. The Quick Start Guides on any NEON data product description page are especially useful for understanding these tables, as are the "variables" and "readme" files included in data downloads. It is recommended that anyone who plans to use NEON data in their work carefully review the associated reading materials. 

# Narrow the spatial and temporal scope based on available data

For our purpose, we are interested in the files containing measurements of carbon and nitrogen, so we will extract those data files. Since the sampling resolution is not equivalent across data products we will summarize each of them based on the availability of carbon nitrogen ratio data in order to find the overlapping sampling points.

```{r summariseData},message=FALSE,evaluate=TRUE}

# Extract and rename tables of interest

cfc <- NEON.cfc$cfc_carbonNitrogen
ltr <- NEON.ltr$ltr_litterCarbonNitrogen

# Summarize data by year and site

summary.cfc <- cfc %>% 
              mutate(year=year(collectDate)) %>% 
              group_by(siteID,year) %>% 
              summarise(n=length(uid),meanCN=mean(CNratio,na.rm=TRUE))

summary.cfc

summary.ltr <- ltr %>% 
              mutate(year=year(collectDate)) %>% 
              group_by(siteID,year) %>% 
              summarise(n=length(uid),meanCN=mean(CNratio,na.rm=TRUE)) 
summary.ltr

```
We can see that there are more year by site combinations for which CN ratio data exist from canopy foliage than from litter samples. Since we are interested in studying both components of the ecosystem, let's subset our data to only those instances for which both sets of data are available. To do this we need to join our datasets by site and year. We will then select one year of data from each of the site x year combinations and add a column for a new "site by year" variable.
                  
```{r joinData},message=FALSE,evaluate=TRUE}

# Join the two summary data frames
CN <- full_join(summary.cfc,summary.ltr,
                  join_by("siteID"=="siteID","year"=="year"),
                  suffix = c(".cfc",".ltr")) %>%
                  filter(meanCN.cfc>0,meanCN.ltr>0)

#choose the most recent year of data when sites have multiple years
CN <- CN %>%
      filter(!duplicated(siteID,fromLast = TRUE)) %>%
      mutate(siteYear=paste(siteID,year,sep="."))

```

We have now identified 31 site by year combinations for which we would like to obtain paired mammal hair and fecal samples for further study! Now we will look for available samples.

# Load and explore NEON Biorepository data

Here, we read in a csv file of occurrence records downloaded from the NEON Biorepository data portal. The results are located in the Github repository https://github.com/kyule/neon-biorepo-tutorial and represent a search for all small mammal hair and fecal samples collected in 2018-2023 and archived at the NEON Biorepository as of 2024-08-02.

Up to date results for the same search terms can be found at any time using the link: 
https://biorepo.neonscience.org/portal/collections/list.php?db=26%2C27&includeothercatnum=1&eventdate1=2018-01-01&eventdate2=2023-12-31&usethes=1&taxontype=1&availableforloan=1

```{r load data, message=FALSE, warning=FALSE}
biorepo<-read.csv(curl("https://github.com/kyule/neon-biorepo-tutorial/raw/main/biorepoOccurrences_FecalAndHairSamples_20240802.csv"))
```

Let's look at what information is included in a Darwin Core occurrence record.

```{r investigate},message=FALSE,evaluate=FALSE}
# What variables exist for the records?

names(biorepo)

```

We see that a large number of Darwin Core fields are present in the results that outline the who, what, where, when, and more of each sample. For fun, let's explore the data. Try grouping or summarizing by any fields that interest you.

```{r explorefields},message=FALSE,evaluate=FALSE}
# How many samples are included in the results for each collection, species, and sex?

biorepo %>% 
  group_by(collectionCode,scientificName,sex) %>% 
  count()

```

_An aside on taxonomic identifications:_ We see several different taxa represented within the results. Most samples are associated with a species-level determination. However, some small mammal species are very difficult to identify while live in the field at some sites. Therefore, some individuals are identified only to genus and others are given a "/" taxon. The latter represent uncertain identification between two species that are difficult to distinguish at a given field site. For example, individuals identified as _Peromyscus leucopus/maniculatus_ could not be confidently determined to be either _P. maniculatus_ or _P. leucopus_ in the field. We will narrow our data to only samples for which a species level identification was made below. Many specimens are also given identification qualifiers, such as "cf. species," which indicates some uncertainty in the field determination. We will ignore those notes for today, but we encourage any researcher interested in NEON small mammal samples to contact the NEON Bioreposity staff (biorepo@asu.edu) to better understand species-level identification confidence. When possible, we are often interested in collaborating with researchers on efforts to confirm identifications.

```{r taxonomicSiteYear},message=FALSE,evaluate=TRUE}

# Remove instances of slash identifications and determinations above the species level

biorepo <- biorepo %>% 
              filter(!grepl("/",scientificName),!is.na(specificEpithet))
```

# Narrow the results to a set of samples that fits our research question

We want to include only samples collected from the same site x year combinations we are interested in based on CN ratio data.

```{r sampleScope},message=FALSE,evaluate=TRUE}

# Create a site by year column and filter the sample results

biorepo <- biorepo %>% 
              mutate(siteID=substr(locationID,1,4)) %>% 
              mutate(siteYear=paste(siteID,year,sep=".")) %>%
              filter(siteYear %in% CN$siteYear)

```

Different collectionCodes correspond to different sample types. 

"MAMC-HA" corresponds to the **Mammal Hair Sample Collection** described here: https://biorepo.neonscience.org/portal/collections/misc/collprofiles.php?collid=27). 

"MAMC-FE" corresponds to the **Mammal Fecal Sample Collection** described here: https://biorepo.neonscience.org/portal/collections/misc/collprofiles.php?collid=26). 

We will separate the hair and fecal samples into seperate data frames for ease of use 

```{r sepCollections},message=FALSE,evaluate=TRUE}

# Extract the hair and fecal samples

hair <- biorepo %>%
          filter(collectionCode=="MAMC-HA")

fecal <- biorepo %>%
          filter(collectionCode=="MAMC-FE")

```

We see that there are a large number of samples that fit the site and year criteria of our study. We know that we want to focus on common species because we cannot fully deplete NEON Biorepository resources for future researchers (https://biorepo.neonscience.org/portal/misc/samplepolicy.php) and we want to make sure we have sufficient within species replication for our analyses (and likely have our own resource constraints!). Therefore, we can subset the available samples based on the sampling rate for different species' hair.


```{r collectingBySpp},message=FALSE,evaluate=TRUE}

# Find how common different species, select the 3 most common species for each site, and add a site by species column

hairBySpecies <- hair %>% 
                  group_by(siteID,scientificName) %>% 
                  count() %>% 
                  arrange(desc(n)) %>%
                  group_by(siteID) %>%
                  slice(1:3) %>% 
                  mutate(siteSp=paste(siteID,scientificName,sep="_"))

# Filter both the hair and fecal samples by these site by species combinations

hair <- hair %>% 
          mutate(siteSp=paste(siteID,scientificName,sep="_")) %>%
          filter(siteSp %in% hairBySpecies$siteSp)

fecal <- fecal %>% 
          mutate(siteSp=paste(siteID,scientificName,sep="_")) %>%
          filter(siteSp %in% hairBySpecies$siteSp)

```

We now need to determine which fecal and hair samples are associated with the same individual. We can determine this based on the "associatedOccurrences" field in the NEON Biorepository occurrences field. This field provides url links to samples that can be related in a variety of ways. See the Darwin Core reference guide to understand this and other controlled terminology: https://dwc.tdwg.org/terms/

These urls are pipe delimited and contain the "catalogNumber" for related samples. The only relationship between  mammal hair and fecal samples in the NEON Biorepository data portal is "derivedFromSameIndividual." We will extract relationships from the "associatedOccurrences" field to create a new data frame of catalogNumbers of paired samples. The code to do this provided below is a for loop that cycles through several thousand samples, so it may take a few minutes to run.

```{r matchSamples},message=FALSE,evaluate=TRUE}

# Find pairs of hair and fecal samples associated with the same individuals

matches <- data.frame(hair=c(),fecal=c())

for (i in 1:nrow(fecal)){
  matchHair <- hair$catalogNumber[grepl(fecal$catalogNumber[i],hair$associatedOccurrences)][1]
  
  if(is.na(matchHair) == FALSE){
    matches <- rbind(matches,data.frame(hair=matchHair,fecal=fecal$catalogNumber[i]))
  }
  
}

# Remove duplicate samples from this list

matches <- matches %>% filter(!duplicated(hair))

```

We find nearly 1500 unique individuals with paired hair and fecal samples meeting our criteria so far. Let's summarize by the number of samples across site by species combinations and filter to those combinations for which 10 or more individuals are available.

```{r create the hair data frame},message=FALSE,evaluate=TRUE}

hairMatches <- matches %>% 
                left_join(hair,join_by("hair"=="catalogNumber")) 

hairMatchSummary <- hairMatches %>%
                      group_by(siteSp) %>% 
                      count() %>% 
                      filter(n>=10)

```

