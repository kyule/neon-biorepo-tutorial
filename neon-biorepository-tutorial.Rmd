---
title: "NEON Biorepository Data Tutorial"
author: "Kelsey Yule"
date: "2024-07-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Learning Objectives

In this tutorial, we will use NEON small mammals as an example to learn how to: 

1. Explore Darwin Core records downloaded from the NEON Biorepository data portal: https://biorepo.neonscience.org

2. Summarize NEON Biorepository sample availability based on spatial, temporal, and taxonomic factors.

3. Download related data from the main NEON data portal using the neonUtilities R package.

3. Join NEON data to associated sample data.

4. Compare NEON Biorepository specimen data to field collected data.

5. Develop a list of samples based on analysis of sample-associated field data.

## Research questions

1. How do NEON **field** and **Biorepository** measurements of deermice (_Peromyscus_) **body masses** compare?

2. Can we obtain a **suitable sample list** to study 5 sets of paired DNA and fecal samples from male _Peromyscus leucopus_ individuals at each of 10 NEON field sites?

## Background information

The NEON Biorepository is located at Arizona State University and serves as the primary repository for NEON samples and specimens collected across all 81 NEON field sites. 

The NEON Biorepository data portal allows users to search and download records associated with NEON samples and specimens, request samples and specimens for research, and publish sample-associated data. The NEON Biorepository data portal is built on open-source **Symbiota** software. **Symbiota** is the most frequently used software in North America for managing natural history collections records. Learn more about **Symbiota** data portals at https://symbiota.org/

Symbiota portals publish sample, specimen, and observation data following **Darwin Core Standard** developed by Biodiversity Information Standards (TDWG). This data standard is a stable, straightforward, and flexible framework for compiling biodiversity data from varied sources. Learn more at https://dwc.tdwg.org/

## Getting Started

First, we want to clear out our workspace and load the required packages. If you do not have the required packages installed previously do so with the `install.packages()` function.

```{r set up, message=FALSE, warning=FALSE}
# clean out workspace

# rm(list = ls()) # OPTIONAL - clear out your environment

# load packages
library(tidyverse)
library(neonUtilities)
library(curl)

```

## Load and explore NEON Biorepository data

Here, we read in a csv file of occurrence records downloaded from the NEON Biorepository data portal. The full results are located in the Github repository https://github.com/kyule/neon-biorepo-tutorial and represent a search for all _Peromyscus_ samples archived at the NEON Biorepository as of 2024-07-30.

Up to date results for the same search terms can be found at any time using the link: 
https://biorepo.neonscience.org/portal/collections/list.php?db=24%2C71%2C25%2C26%2C27%2C91%2C90%2C17%2C19%2C28&includeothercatnum=1&taxa=Peromyscus&usethes=1&taxontype=1

```{r load data, message=FALSE, warning=FALSE}
biorepo<-read.csv("https://github.com/kyule/neon-biorepo-tutorial/raw/main/Peromyscus_20240730_DwCRecords/occurrences.csv")
```

Let's look at what information is included in a Darwin Core occurrence record.

```{r investigate},message=FALSE}
# What variables exist for the records?

names(biorepo)

```
We see that a large number of Darwin Core fields are present in the results that outline the who, what, where, when, and more of each sample. Let's explore the data in some fields of interest relative to our questions in order to get a rough understanding of sample availability.

```{r explorefields},message=FALSE}
# How many samples are included in the results for each collection, species, and sex?

sample_summary<-biorepo %>% 
  group_by(collectionCode,scientificName,sex) %>% 
  count()

```

Different collectionCodes correspond to different sample types (e.g. "MAMC-BL" corresponds to the Mammal Blood Sample Collection described here: https://biorepo.neonscience.org/portal/collections/misc/collprofiles.php?collid=24). 

We see several different taxa represented within the results. Most samples are associated with a species-level determination. A few are identified only to genus and others are given a "/" taxon. The latter represent uncertain identification between two species that are difficult to distinguish at a given field site. For example, individuals identified as _Peromyscus leucopus/maniculatus_ could not be confidently determined to be either _P. maniculatus_ or _P. leucopus_ in the field.

## Obtain relevant NEON Terrestrial Observation System data

In order to compare field and Biorepository measurements of body mass, we also need to obtain field data from the main NEON data portal. We will use the `neonUtilities` package to download all small mammal capture data from the main NEON data portal. This requires that we know the NEON data product ID for small mammals, which is DP1.10072.001: https://data.neonscience.org/data-products/DP1.10072.001

The below code chunk allows you to download the data as of 2024-07-30 from the GitHub repository associated with this tutorial.

```{r loadNeondata, message=FALSE, warning=FALSE}
NEON<-readRDS(gzcon(url("https://github.com/kyule/neon-biorepo-tutorial/raw/main/mammalCaptures_20240730.Rdata")))
```
The below code shows how you could download an up-to-date version of this data. We will not download new data today due to the time that would be required to do so. Note that we have chosen to include Provisional data for this exploratory analysis. To learn more about Release vs. Provisional NEON data and ensure that you choose the appropriate data for your purposes, visit the following page: https://www.neonscience.org/resources/learning-hub/tutorials/release-provisional-tutorial.



```{r downloadDataNew},message=FALSE}

# source .r file with my NEON_TOKEN
# source("my_neon_token.R") # OPTIONAL - load NEON token
# See: https://www.neonscience.org/neon-api-tokens-tutorial



sample_summary<-biorepo %>% 
  group_by(collectionCode,scientificName,sex) %>% 
  count()

```


